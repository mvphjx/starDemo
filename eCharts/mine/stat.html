<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ECharts统计示例</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
</head>
<body>
<div id="hourStat" style="width: 900px;height:400px;"></div>
<div id="monthStat" style="width: 900px;height:400px;"></div>
<div id="dateStat" style="width: 900px;height:1200px;"></div>
<script>
    var fileUrl = 'data.txt';
    var datetimeArray = [];

    function initFile() {
        fetch(fileUrl)
            .then(response => {
                // 确保响应状态是成功的
                if (!response.ok) {
                    throw new Error('网络响应错误');
                }
                // 解析文本内容
                return response.text();
            })
            .then(text => {
                // 将文本按行分割成数组
                const lines = text.split('\n');
                // 过滤掉可能的空行
                datetimeArray = lines.filter(line => line.trim() !== '');
                initEcharts();
            })
    }

    var hourlyData = {};
    var monthlyData = {};
    var daylyData = {};

    function initEcharts() {
        //数据清洗，转为统计数据
        datetimeArray.forEach(function (dateStr) {
            var date = parseDate(dateStr) // 转换为Date对象
            var year = date.year();
            var month = (date.month() + 1).toString().padStart(2, '0');
            var day = date.date();
            var hour = date.hour();
            var minutes = date.minute();
            var seconds = date.second();
            var monthKey = year + '-' + month;
            var calendarKey = [year, month, day].join('-');
            if (!monthlyData[monthKey]) {
                monthlyData[monthKey] = 1;
            } else {
                monthlyData[monthKey]++;
            }
            //过滤掉缺少时间的数据
            if (minutes != 0 || seconds != 0 || hour != 0) {
                if (!hourlyData[hour]) {
                    hourlyData[hour] = 1;
                } else {
                    hourlyData[hour]++;
                }
            }
            if (!daylyData[calendarKey]) {
                daylyData[calendarKey] = 1;
            } else {
                daylyData[calendarKey]++;
            }
        });
        hourEcharts();
        monthEcharts();
        dateEcharts();
    }

    function hourEcharts() {
        // 准备 ECharts 数据
        var hours = Object.keys(hourlyData).map(Number);
        var counts = hours.map(hour => hourlyData[hour]);
        // 使用 ECharts 绘制柱状图
        var myChart = echarts.init(document.getElementById('hourStat'));
        var option = {
            title: {
                text: '按小时统计'
            },
            tooltip: {},
            xAxis: {
                type: 'category',
                data: hours
            },
            yAxis: {
                type: 'value'
            },
            series: [{
                data: counts,
                type: 'bar',
                barWidth: '60%'
            }]
        };
        // 使用刚指定的配置项和数据显示图表。
        myChart.setOption(option);
    }

    function parseDate(dateStr) {
        dateStr = dateStr.replace("\r", "")
        let format = "YYYY年MM月DD日HH:mm:ss";
        if (dateStr.indexOf('年') == -1) {
            if (dateStr.length == 10) {
                format = "YYMMDDHHmm";
            } else {
                format = "YYYYMMDDHHmmss";
            }
        }
        let jsDate = moment(dateStr, format);
        return jsDate;
    }

    /**
     * 日期分布
     */
    function dateEcharts() {
        // 基于准备好的dom，初始化echarts实例
        var myChart = echarts.init(document.getElementById('dateStat'));
        // 指定图表的配置项和数据
        var option = {
            title: {
                text: '按天统计'
            },
            tooltip: {
                position: 'top',
                formatter: function (p) {
                    const format = echarts.time.format(p.data[0], '{yyyy}-{MM}-{dd}', false);
                    return format + ': ' + p.data[1];
                }
            },
            visualMap: {
                min: 0,
                max: 4,
                calculable: true,
                orient: 'vertical',
                left: '670',
                top: 'center'
            },
            calendar: [
                {
                    orient: 'vertical',
                    range: '2023'
                },
                {
                    left: 300,
                    orient: 'vertical',
                    range: '2024'
                },
                {
                    left: 520,
                    cellSize: [20, 'auto'],
                    bottom: 10,
                    orient: 'vertical',
                    range: '2025',
                    dayLabel: {
                        margin: 5
                    }
                }
            ],
            series: [
                {
                    type: 'heatmap',
                    coordinateSystem: 'calendar',
                    calendarIndex: 0,
                    data: getVirtualData('2023')
                },
                {
                    type: 'heatmap',
                    coordinateSystem: 'calendar',
                    calendarIndex: 1,
                    data: getVirtualData('2024')
                },
                {
                    type: 'heatmap',
                    coordinateSystem: 'calendar',
                    calendarIndex: 2,
                    data: getVirtualData('2024')
                }
            ]
        };
        // 使用刚指定的配置项和数据显示图表。
        myChart.setOption(option);
    }


    function getVirtualData(yearStr) {
        // 创建一个空数组来存储结果
        var calendarData = [];
        // 遍历数据对象，将每个键值对添加到calendarData数组中
        for (var date in daylyData) {
            if (daylyData.hasOwnProperty(date)) {
                // 检查年份是否匹配
                if (date.substring(0, 4) === yearStr) {
                    // 将日期和对应的值作为数组元素添加到calendarData中
                    calendarData.push([date, daylyData[date]]);
                }
            }
        }
        return calendarData;
    }

    /**
     * 月分布
     */
    function monthEcharts() {
        var myChart = echarts.init(document.getElementById('monthStat'));
        // 准备 ECharts 的数据
        var xAxisData = Object.keys(monthlyData).map(function (key) {
            return key; // 这里直接使用年月作为x轴数据
        });
        var seriesData = Object.values(monthlyData);

        // 指定图表的配置项和数据
        var option = {
            title: {
                text: '每月数量分布'
            },
            tooltip: {},
            xAxis: {
                type: 'category',
                data: xAxisData
            },
            yAxis: {
                type: 'value'
            },
            series: [{
                name: '数量',
                type: 'bar',
                data: seriesData
            }]
        };

        // 使用刚指定的配置项和数据显示图表。
        myChart.setOption(option);
    }


    initFile();

</script>
</body>
</html>
